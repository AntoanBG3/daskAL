@using Microsoft.AspNetCore.Components.Authorization
@using SchoolManagementSystem.Web.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<AuthorizeView>
    <Authorized>
        <div class="dropdown">
            <button class="btn btn-outline-light d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="avatar-circle me-2">@GetInitials(context.User.Identity?.Name)</span>
                <span class="d-none d-md-inline">@context.User.Identity?.Name</span>
                <i class="bi bi-chevron-down ms-1"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                <li class="dropdown-header">
                    <div class="fw-bold">@context.User.Identity?.Name</div>
                    <small class="text-info">@GetRole(context.User)</small>
                </li>
                <li><hr class="dropdown-divider"></li>
                <AuthorizeView Roles="Student" Context="studentContext">
                    <li>
                        <a class="dropdown-item" href="my-profile">
                            <i class="bi bi-person me-2"></i> My Profile
                        </a>
                    </li>
                </AuthorizeView>
                <li>
                    <a class="dropdown-item" href="messages">
                        <i class="bi bi-envelope me-2"></i> Messages
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <button class="dropdown-item text-danger" @onclick="Logout">
                        <i class="bi bi-box-arrow-right me-2"></i> Sign Out
                    </button>
                </li>
            </ul>
        </div>
    </Authorized>
    <NotAuthorized>
        <a href="login" class="btn btn-light me-2">
            <i class="bi bi-box-arrow-in-right me-1"></i> Login
        </a>
        <a href="register" class="btn btn-outline-light">
            <i class="bi bi-person-plus me-1"></i> Register
        </a>
    </NotAuthorized>
</AuthorizeView>

<style>
    .avatar-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background-color: #4f46e5;
        color: white;
        border-radius: 50%;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>

@code {
    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }
    
    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
    
    private string GetRole(System.Security.Claims.ClaimsPrincipal user)
    {
        if (user.IsInRole("Admin")) return "Administrator";
        if (user.IsInRole("Teacher")) return "Teacher";
        if (user.IsInRole("Student")) return "Student";
        return "User";
    }
}
