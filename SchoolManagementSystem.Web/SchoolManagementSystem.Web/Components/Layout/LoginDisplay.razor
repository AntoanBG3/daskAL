@using Microsoft.AspNetCore.Components.Authorization
@using SchoolManagementSystem.Web.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<AuthorizeView>
    <Authorized>
        <div class="dropdown">
            <button class="btn btn-link link-dark text-decoration-none d-flex align-items-center p-0 border-0 bg-transparent" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <div class="avatar-circle me-2">@GetInitials(context.User.Identity?.Name)</div>
                <div class="d-none d-md-flex flex-column text-start lh-1">
                    <span class="fw-semibold text-dark" style="font-size: 0.9rem;">@context.User.Identity?.Name</span>
                    <span class="text-xs text-muted" style="font-size: 0.75rem;">@GetRole(context.User)</span>
                </div>
                <i class="bi bi-chevron-down ms-2 text-muted small"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2" style="border-radius: 0.5rem; min-width: 200px;">
                <li class="px-3 py-2 border-bottom mb-2 bg-light">
                     <span class="d-block fw-bold text-dark">@context.User.Identity?.Name</span>
                     <span class="d-block small text-muted">@GetRole(context.User)</span>
                </li>
                
                <AuthorizeView Roles="Student" Context="studentContext">
                    <li>
                        <a class="dropdown-item py-2" href="my-profile">
                            <i class="bi bi-person me-2 text-primary"></i> My Profile
                        </a>
                    </li>
                </AuthorizeView>
                <li>
                    <a class="dropdown-item py-2" href="messages">
                        <i class="bi bi-envelope me-2 text-primary"></i> Messages
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form action="/logout" method="post">
                        <AntiforgeryToken />
                        <button type="submit" class="dropdown-item py-2 text-danger fw-medium">
                            <i class="bi bi-box-arrow-right me-2"></i> Sign Out
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="d-flex gap-2">
            <a href="login" class="btn btn-sm btn-outline-primary fw-medium px-3">
                Log In
            </a>
            <a href="register" class="btn btn-sm btn-primary fw-medium px-3">
                Register
            </a>
        </div>
    </NotAuthorized>
</AuthorizeView>

<style>
    .avatar-circle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary), var(--primary-hover));
        color: white;
        border-radius: 50%;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
    }
</style>

@code {
    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
    
    private string GetRole(System.Security.Claims.ClaimsPrincipal user)
    {
        if (user.IsInRole("Admin")) return "Administrator";
        if (user.IsInRole("Teacher")) return "Teacher";
        if (user.IsInRole("Student")) return "Student";
        return "User";
    }
}