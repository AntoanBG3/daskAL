@page "/messages"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using SchoolManagementSystem.Web.Models
@using SchoolManagementSystem.Web.Models.ViewModels
@using SchoolManagementSystem.Web.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject MessageService MessageService
@inject TeacherService TeacherService
@inject NavigationManager NavigationManager
@inject UserManager<User> UserManager
@attribute [Authorize]

<PageTitle>Messages</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-envelope-fill me-2"></i>Messages</h2>
        @if (ActiveTab != "compose")
        {
            <button class="btn btn-primary" @onclick='() => SetTab("compose")'>
                <i class="bi bi-pencil-square me-2"></i>New Message
            </button>
        }
    </div>

    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "inbox" ? "active" : "")" @onclick='() => SetTab("inbox")'>Inbox</button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "sent" ? "active" : "")" @onclick='() => SetTab("sent")'>Sent</button>
        </li>
        @if (ActiveTab == "compose")
        {
            <li class="nav-item">
                <button class="nav-link active">Compose</button>
            </li>
        }
    </ul>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        @if (ActiveTab == "inbox")
        {
            <div class="list-group shadow-sm">
                @if (InboxMessages.Any())
                {
                    @foreach (var msg in InboxMessages)
                    {
                        <div class="list-group-item list-group-item-action flex-column align-items-start @(msg.IsRead ? "" : "fw-bold bg-light")">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@msg.Subject</h5>
                                <small class="text-muted">@msg.SentAt.ToLocalTime().ToString("g")</small>
                            </div>
                            <p class="mb-1">From: @(msg.Sender?.Email ?? "Unknown")</p>
                            <small class="text-muted">@msg.Content</small> 
                             @if (!msg.IsRead)
                            {
                                <button class="btn btn-sm btn-outline-secondary float-end" @onclick="() => MarkAsRead(msg.Id)">Mark Read</button>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="p-4 text-center text-muted">No messages in Inbox</div>
                }
            </div>
        }
        else if (ActiveTab == "sent")
        {
            <div class="list-group shadow-sm">
                @if (SentMessages.Any())
                {
                    @foreach (var msg in SentMessages)
                    {
                        <div class="list-group-item list-group-item-action flex-column align-items-start">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@msg.Subject</h5>
                                <small class="text-muted">@msg.SentAt.ToLocalTime().ToString("g")</small>
                            </div>
                            <p class="mb-1">To: @(msg.Receiver?.Email ?? "Unknown")</p>
                            <small class="text-muted">@msg.Content</small>
                        </div>
                    }
                }
                else
                {
                     <div class="p-4 text-center text-muted">No sent messages</div>
                }
            </div>
        }
        else if (ActiveTab == "compose")
        {
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">To:</label>
                        <select class="form-select" @bind="NewMessageReceiverEmail">
                             <option value="">Select Recipient...</option>
                            @foreach (var recipient in AvailableRecipients)
                            {
                                <option value="@recipient.Email">@recipient.Name (@recipient.Role)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject:</label>
                        <input type="text" class="form-control" @bind="NewMessageSubject" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message:</label>
                        <textarea class="form-control" rows="5" @bind="NewMessageContent"></textarea>
                    </div>
                    <button class="btn btn-primary" @onclick="SendMessage">
                        <i class="bi bi-send-fill me-1"></i> Send
                    </button>
                    <button class="btn btn-secondary ms-2" @onclick='() => SetTab("inbox")'>Cancel</button>
                </div>
            </div>
        }
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public string? ComposeTo { get; set; }

    private string ActiveTab = "inbox";
    private bool IsLoading = true;
    private string CurrentUserId = "";
    
    private List<Message> InboxMessages = new();
    private List<Message> SentMessages = new();
    
    // Compose Form
    private string NewMessageReceiverEmail = "";
    private string NewMessageSubject = "";
    private string NewMessageContent = "";
    
    private List<RecipientOption> AvailableRecipients = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            CurrentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
            
            if (!string.IsNullOrEmpty(CurrentUserId))
            {
                await LoadMessages();
                await LoadRecipients(user);
            }
        }
        
        if (!string.IsNullOrEmpty(ComposeTo))
        {
             SetTab("compose");

             if (int.TryParse(ComposeTo, out int teacherId))
             {
                 var teacher = await TeacherService.GetTeacherByIdAsync(teacherId);
                 if (teacher != null)
                 {
                    // Attempt to find user
                    // TeacherViewModel doesn't have UserId, we need to fetch entity or look up
                    var teacherEntity = await TeacherService.GetTeacherByUserIdAsync(""); // No, this finds BY userId

                    // We need GetTeacherById -> Teacher -> UserId -> User -> Email
                    // The service GetTeacherByIdAsync returns ViewModel.
                    // Let's rely on finding by name in available recipients for now, or fetch all users?

                    // Better: Loop through available recipients and match name?
                    // Name matching is weak.
                    // Let's just fix the dropdown to list all Teachers properly first.
                 }
             }
        }
        
        IsLoading = false;
    }

    private async Task LoadMessages()
    {
        InboxMessages = await MessageService.GetMessagesForUserAsync(CurrentUserId);
        SentMessages = await MessageService.GetSentMessagesAsync(CurrentUserId);
    }

    private async Task LoadRecipients(ClaimsPrincipal currentUser)
    {
        AvailableRecipients.Clear();
        
        // Get all users in relevant roles
        var admins = await UserManager.GetUsersInRoleAsync("Admin");
        var teachers = await UserManager.GetUsersInRoleAsync("Teacher");
        var students = await UserManager.GetUsersInRoleAsync("Student");
        
        foreach(var u in admins)
            AvailableRecipients.Add(new RecipientOption { Name = $"{u.FirstName} {u.LastName}", Email = u.Email!, Role = "Admin" });
            
        foreach(var u in teachers)
            AvailableRecipients.Add(new RecipientOption { Name = $"{u.FirstName} {u.LastName}", Email = u.Email!, Role = "Teacher" });
            
        // If I am a teacher, I can message students
        if (currentUser.IsInRole("Teacher") || currentUser.IsInRole("Admin"))
        {
             foreach(var u in students)
                AvailableRecipients.Add(new RecipientOption { Name = $"{u.FirstName} {u.LastName}", Email = u.Email!, Role = "Student" });
        }
        
        // Handle ComposeTo Pre-selection
        if (!string.IsNullOrEmpty(ComposeTo) && int.TryParse(ComposeTo, out int teacherId))
        {
             // We have Teacher ID. We need to select the email.
             // We can fetch the Teacher Entity to get the UserId, then match.
             // But we don't have access to Teacher Entity here easily without a new Service method.
             // HACK: Match by Name from Teacher Service?
             var teacherVM = await TeacherService.GetTeacherByIdAsync(teacherId);
             if (teacherVM != null)
             {
                 var match = AvailableRecipients.FirstOrDefault(r => r.Name == teacherVM.FullName && r.Role == "Teacher");
                 if (match != null) NewMessageReceiverEmail = match.Email;
             }
        }
    }

    private void SetTab(string tab)
    {
        ActiveTab = tab;
    }

    private async Task MarkAsRead(int id)
    {
        await MessageService.MarkMessageAsReadAsync(id);
        await LoadMessages();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(NewMessageReceiverEmail) || string.IsNullOrWhiteSpace(NewMessageContent)) return;

        try 
        {
            await MessageService.SendMessageAsync(CurrentUserId, NewMessageReceiverEmail, NewMessageSubject, NewMessageContent);
            NewMessageSubject = "";
            NewMessageContent = "";
            NewMessageReceiverEmail = "";
            SetTab("sent");
            await LoadMessages();
        }
        catch (Exception ex)
        {
            // Show error (alert)
            Console.WriteLine(ex.Message);
        }
    }
    
    public class RecipientOption
    {
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Role { get; set; } = "";
    }
}
