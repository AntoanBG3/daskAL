@page "/students/add"
@attribute [Authorize(Roles = "Admin,Teacher")]
@inject SchoolManagementSystem.Web.Services.StudentService StudentService
@inject SchoolManagementSystem.Web.Services.ClassService ClassService
@inject NavigationManager Navigation
@using SchoolManagementSystem.Web.Models.ViewModels

<h3>Add New Student</h3>

@if (classes == null)
{
    <p>Loading classes...</p>
}
else
{
    <EditForm Model="@student" OnValidSubmit="HandleValidSubmit" FormName="AddStudentForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">First Name</label>
            <InputText class="form-control" @bind-Value="student.FirstName" />
            <ValidationMessage For="@(() => student.FirstName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Last Name</label>
            <InputText class="form-control" @bind-Value="student.LastName" />
            <ValidationMessage For="@(() => student.LastName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Class</label>
            <InputSelect class="form-select" @bind-Value="student.Class">
                <option value="">-- Select Class --</option>
                @foreach (var c in classes)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => student.Class)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date of Birth</label>
            <InputDate class="form-control" @bind-Value="student.DateOfBirth" />
            <ValidationMessage For="@(() => student.DateOfBirth)" />
        </div>

        <button type="submit" class="btn btn-primary">Save Student</button>
        <a href="students" class="btn btn-secondary ms-2">Cancel</a>
    </EditForm>
}

@code {
    [SupplyParameterFromForm]
    private StudentViewModel student { get; set; } = new() { DateOfBirth = DateTime.Today.AddYears(-15) }; // Default nice date

    private List<SchoolClassViewModel>? classes;

    protected override async Task OnInitializedAsync()
    {
        classes = await ClassService.GetAllClassesAsync();
    }

    private async Task HandleValidSubmit()
    {
        // student.Class now holds the ID as a string due to ViewModel design (backwards compat).
        // Ideally should update ViewModel to have int ClassId, but let's parse it for now or rely on Service Overload.
        // SchoolService.AddStudentAsync(model) calls int.TryParse(model.Class).
        // So binding the ID to string Class property works if value is the ID.
        await StudentService.AddStudentAsync(student);
        Navigation.NavigateTo("students");
    }
}
