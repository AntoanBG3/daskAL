@page "/students/add"
@attribute [Authorize(Roles = "Admin,Teacher")]
@inject SchoolManagementSystem.Web.Services.StudentService StudentService
@inject SchoolManagementSystem.Web.Services.ClassService ClassService
@inject NavigationManager Navigation
@using SchoolManagementSystem.Web.Models.ViewModels

<h3>Add New Student</h3>

@if (classes == null)
{
    <p>Loading classes...</p>
}
else
{
    <EditForm Model="@student" OnValidSubmit="HandleValidSubmit" FormName="AddStudentForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">First Name</label>
            <InputText class="form-control" @bind-Value="student.FirstName" />
            <ValidationMessage For="@(() => student.FirstName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Last Name</label>
            <InputText class="form-control" @bind-Value="student.LastName" />
            <ValidationMessage For="@(() => student.LastName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Class</label>
            <InputSelect class="form-select" @bind-Value="student.ClassId">
                <option value="">-- Select Class --</option>
                @foreach (var c in classes)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => student.ClassId)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Date of Birth</label>
            <InputDate class="form-control" @bind-Value="student.DateOfBirth" />
            <ValidationMessage For="@(() => student.DateOfBirth)" />
        </div>

        <button type="submit" class="btn btn-primary">Save Student</button>
        <a href="students" class="btn btn-secondary ms-2">Cancel</a>
    </EditForm>
}

@code {
    [SupplyParameterFromForm]
    private StudentViewModel student { get; set; } = new() { DateOfBirth = DateTime.Today.AddYears(-15) }; // Default nice date

    private List<SchoolClassViewModel>? classes;

    protected override async Task OnInitializedAsync()
    {
        classes = await ClassService.GetAllClassesAsync();
    }

    private async Task HandleValidSubmit()
    {
        // Set legacy property just in case validation or other logic needs it, though we rely on ClassId now.
        // Or leave it empty if not needed.
        student.Class = student.ClassId.ToString() ?? "";

        await StudentService.AddStudentAsync(student);
        Navigation.NavigateTo("students");
    }
}
