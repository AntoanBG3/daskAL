@page "/students/edit/{Id:int}"
@attribute [Authorize(Roles = "Admin,Teacher")]
@inject SchoolManagementSystem.Web.Services.StudentService StudentService
@inject SchoolManagementSystem.Web.Services.ClassService ClassService
@inject NavigationManager NavigationManager
@using SchoolManagementSystem.Web.Models.ViewModels

<h3>Edit Student</h3>

@if (student == null || classes == null)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <EditForm Model="@student" OnValidSubmit="HandleValidSubmit" FormName="EditStudentForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">First Name</label>
            <InputText class="form-control" @bind-Value="student.FirstName" />
            <ValidationMessage For="@(() => student.FirstName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Last Name</label>
            <InputText class="form-control" @bind-Value="student.LastName" />
            <ValidationMessage For="@(() => student.LastName)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Class</label>
            <InputSelect class="form-select" @bind-Value="selectedClassId">
                <option value="">-- Select Class --</option>
                @foreach (var c in classes)
                {
                    <option value="@c.Id">@c.Name</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label class="form-label">Date of Birth</label>
            <InputDate class="form-control" @bind-Value="student.DateOfBirth" />
            <ValidationMessage For="@(() => student.DateOfBirth)" />
        </div>

        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="students" class="btn btn-secondary ms-2">Cancel</a>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    private StudentViewModel student { get; set; } = new();

    private List<SchoolClassViewModel>? classes;
    private string selectedClassId = ""; // Bind to string for simplicity with Select, fetch manually

    protected override async Task OnInitializedAsync()
    {
        classes = await ClassService.GetAllClassesAsync();
        var existingStudent = await StudentService.GetStudentByIdAsync(Id);
        if (existingStudent != null)
        {
            student = existingStudent;
            // Pre-select class based on Name match? Or better, implement GetSchoolClassByStudentId in service?
            // StudentViewModel currently returns "Class Name".
            // Finding the ID from Name is risky but current best effort without changing ViewModel heavily.
            var match = classes.FirstOrDefault(c => c.Name == student.Class);
            if(match != null) selectedClassId = match.Id.ToString();
        }
    }

    private async Task HandleValidSubmit()
    {
        if(int.TryParse(selectedClassId, out int classId))
        {
             // We pass the ID to proper service method
             await StudentService.UpdateStudentAsync(student, classId);
             NavigationManager.NavigateTo("students");
        }
    }
}
