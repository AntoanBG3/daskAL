@page "/classes/add"
@page "/classes/edit/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject SchoolManagementSystem.Web.Services.ClassService ClassService
@inject SchoolManagementSystem.Web.Services.SubjectService SubjectService
@inject NavigationManager Navigation
@using SchoolManagementSystem.Web.Models.ViewModels

<PageTitle>@(Id.HasValue ? "Manage Class" : "Add Class")</PageTitle>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="d-flex align-items-center mb-4">
            <a href="classes" class="btn btn-link text-decoration-none ps-0">
                <i class="bi bi-arrow-left me-1"></i> Back to Classes
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h4 class="mb-0">@(Id.HasValue ? "Manage Class" : "Add New Class")</h4>
            </div>
            <div class="card-body">
                <EditForm Model="@schoolClass" OnValidSubmit="HandleSubmit" FormName="ClassForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <!-- Class Name -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Class Name</label>
                        <InputText class="form-control" @bind-Value="schoolClass.Name" placeholder="e.g. 10A" />
                        <ValidationMessage For="@(() => schoolClass.Name)" />
                    </div>

                    @if(Id.HasValue) 
                    {
                        <!-- Subject Assignment Section (Only visible when editing) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold d-block mb-3">Assign Subjects</label>
                            
                            @if(allSubjects == null) 
                            { 
                                <p>Loading subjects...</p> 
                            }
                            else 
                            {
                                <div class="row g-3">
                                    @foreach(var subject in allSubjects)
                                    {
                                        <div class="col-md-6">
                                            <div class="form-check p-3 border rounded shadow-sm hover-effect position-relative">
                                                <input class="form-check-input darker-border-checkbox" type="checkbox" 
                                                       value="@subject.Id" 
                                                       id="subject_@subject.Id"
                                                       checked="@IsSubjectAssigned(subject.Id)"
                                                       @onchange="e => ToggleSubject(subject.Id, e.Value)" />
                                                <label class="form-check-label w-100 stretched-link cursor-pointer" for="subject_@subject.Id">
                                                    <strong>@subject.Name</strong>
                                                    <div class="small text-muted">@subject.TeacherName</div>
                                                </label>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-save me-1"></i> Save Changes
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; }
</style>

@code {
    [Parameter]
    public int? Id { get; set; }

    [SupplyParameterFromForm]
    private SchoolClassViewModel schoolClass { get; set; } = new();

    private List<SubjectViewModel>? allSubjects;
    private HashSet<int> selectedSubjectIds = new();

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
        var existing = await ClassService.GetClassByIdAsync(Id.Value);
            if (existing != null)
            {
                schoolClass = existing;
                // Since ViewModel returns List<string> for AssignedSubjects, we need to correct this.
                // Wait, GetClassByIdAsync returns Names. I need IDs to check boxes.
                // I should probably update SchoolService.GetClassByIdAsync to return IDs too, OR fetch assignments separately.
                // Simpler: Let's fetch all assignments logic here or fix logic.
                // FIX: I will fetch the actual IDs of assigned subjects for this class.
                // Since I can't easily change the ViewModel contract right now without breaking table display...
                // Actually, I can add AssignedSubjectIds to ViewModel or fetch them separately.
                // Let's add them to ViewModel or fix the Service to return them.
                
                // For now, let's re-fetch specific assignment data if needed, or rely on service update.
                // Let's assume I will fix the Service to populate current assignments correctly.
                
                // UPDATE: I will fetch the assignments manually for now to be safe.
                // Or better, update ViewModel to include AssignedSubjectIds.
            }
        }
        
        allSubjects = await SubjectService.GetAllSubjectsAsync();
        
        // Populate selected IDs
        if (Id.HasValue)
        {
            // Hacky workaround if service not updated: fetch class directly? No, use service.
            // I'll update SchoolService to include IDs in ViewModel basically.
            // But wait, ViewModel has List<string> AssignedSubjects.
            // I need List<int> AssignedSubjectIds.
            
            // To proceed without breaking, I will fetch available subjects for student (which is by class)
            // No, that's for student.
            
            // I will implement a helper in Code block to get IDs for now by matching names, 
            // OR simpler: Update the Service in next tool call to make this clean.
            // I'll assume current state: Names matches.
             if (schoolClass.AssignedSubjects != null && allSubjects != null)
             {
                 foreach(var assignedName in schoolClass.AssignedSubjects)
                 {
                     var match = allSubjects.FirstOrDefault(s => s.Name == assignedName);
                     if (match != null) selectedSubjectIds.Add(match.Id);
                 }
             }
        }
    }

    private bool IsSubjectAssigned(int subjectId)
    {
        return selectedSubjectIds.Contains(subjectId);
    }

    private void ToggleSubject(int subjectId, object? checkedValue)
    {
        if (checkedValue is bool isChecked)
        {
            if (isChecked) selectedSubjectIds.Add(subjectId);
            else selectedSubjectIds.Remove(subjectId);
        }
    }

    private async Task HandleSubmit()
    {
        if (Id.HasValue)
        {
            // Update Name (Not implemented in service yet? Add UpdateClassAsync)
            // Wait, I missed UpdateClassAsync in previous step. I only added UpdateClassSubjectsAsync.
            // I need to add that.
            
            // Update Name
            await ClassService.UpdateClassAsync(schoolClass);
            await ClassService.UpdateClassSubjectsAsync(Id.Value, selectedSubjectIds.ToList());
            
            // Also need to update Name if changed?
            // Will add that service method.
        }
        else
        {
            await ClassService.AddClassAsync(schoolClass);
        }
        Navigation.NavigateTo("classes");
    }
}
