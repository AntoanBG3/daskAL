@page "/teachers/add"
@inject SchoolManagementSystem.Web.Services.TeacherService TeacherService
@inject SchoolManagementSystem.Web.Services.IAuthService AuthService
@inject NavigationManager NavigationManager
@using SchoolManagementSystem.Web.Models.ViewModels
@using SchoolManagementSystem.Web.DTOs
@using Microsoft.AspNetCore.Identity
@using SchoolManagementSystem.Web.Models.Auth
@inject UserManager<User> UserManager
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<h3>Add New Teacher</h3>

<EditForm Model="@teacher" OnValidSubmit="HandleValidSubmit" FormName="AddTeacherForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="firstName" class="form-label">First Name</label>
        <InputText id="firstName" class="form-control" @bind-Value="teacher.FirstName" />
    </div>

    <div class="mb-3">
        <label for="lastName" class="form-label">Last Name</label>
        <InputText id="lastName" class="form-control" @bind-Value="teacher.LastName" />
    </div>

    <hr/>
    <h5>Create Login (Optional)</h5>
    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <InputText id="email" class="form-control" @bind-Value="email" />
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <InputText id="password" type="password" class="form-control" @bind-Value="password" />
    </div>

    <button type="submit" class="btn btn-primary">Add Teacher</button>
    <a href="/teachers" class="btn btn-secondary">Cancel</a>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private TeacherViewModel teacher { get; set; } = new();

    [SupplyParameterFromForm]
    private string? email { get; set; }

    [SupplyParameterFromForm]
    private string? password { get; set; }

    private async Task HandleValidSubmit()
    {
        string? userId = null;
        if (!string.IsNullOrWhiteSpace(email) && !string.IsNullOrWhiteSpace(password))
        {
            // We use RegisterAsync but we need to intercept to activate the user immediately
            // because Admin is creating this account.
            var result = await AuthService.RegisterAsync(new RegisterRequest {
                Email = email,
                Password = password,
                FirstName = teacher.FirstName,
                LastName = teacher.LastName
            });

            if (result.Success)
            {
                 var user = await UserManager.FindByEmailAsync(email);
                 if (user != null)
                 {
                     userId = user.Id;

                     // 1. Activate Account immediately
                     user.IsActive = true;
                     await UserManager.UpdateAsync(user);

                     // 2. Fix Roles (Remove Student, Add Teacher)
                     if (await UserManager.IsInRoleAsync(user, "Student"))
                     {
                         await UserManager.RemoveFromRoleAsync(user, "Student");
                     }

                     if (!await UserManager.IsInRoleAsync(user, "Teacher"))
                     {
                         await UserManager.AddToRoleAsync(user, "Teacher");
                     }

                     // 3. RegisterAsync creates a pending Student entity. We should remove that.
                     // The teacher entity is created by TeacherService.AddTeacherAsync below.
                     // We don't want a stray Student record for this teacher.
                     var dbContext = (SchoolManagementSystem.Web.Data.SchoolDbContext)TeacherService.GetType()
                         .GetField("_context", System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance)
                         ?.GetValue(TeacherService)!;

                     // Since I cannot access _context easily if private, let's inject DbContext or use a hack.
                     // Wait, I can inject DbContext into the page.
                 }
            }
        }

        await TeacherService.AddTeacherAsync(teacher, userId);

        // Clean up the student entity if it was created during registration
        if (userId != null)
        {
             await CleanupPendingStudent(userId);
        }

        NavigationManager.NavigateTo("/teachers");
    }

    [inject]
    SchoolManagementSystem.Web.Data.SchoolDbContext DbContext { get; set; }

    private async Task CleanupPendingStudent(string userId)
    {
        var student = await Microsoft.EntityFrameworkCore.EntityFrameworkQueryableExtensions.FirstOrDefaultAsync(DbContext.Students, s => s.UserId == userId);
        if (student != null)
        {
            DbContext.Students.Remove(student);
            await DbContext.SaveChangesAsync();
        }
    }
}
