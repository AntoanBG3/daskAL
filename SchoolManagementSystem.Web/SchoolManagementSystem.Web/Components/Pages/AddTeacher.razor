@page "/teachers/add"
@inject SchoolManagementSystem.Web.Services.TeacherService TeacherService
@inject SchoolManagementSystem.Web.Services.IAuthService AuthService
@inject NavigationManager NavigationManager
@using SchoolManagementSystem.Web.Models.ViewModels
@using SchoolManagementSystem.Web.DTOs
@using Microsoft.AspNetCore.Identity
@using SchoolManagementSystem.Web.Models.Auth
@inject UserManager<User> UserManager

<h3>Add New Teacher</h3>

<EditForm Model="@teacher" OnValidSubmit="HandleValidSubmit" FormName="AddTeacherForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="firstName" class="form-label">First Name</label>
        <InputText id="firstName" class="form-control" @bind-Value="teacher.FirstName" />
    </div>

    <div class="mb-3">
        <label for="lastName" class="form-label">Last Name</label>
        <InputText id="lastName" class="form-control" @bind-Value="teacher.LastName" />
    </div>

    <hr/>
    <h5>Create Login (Optional)</h5>
    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <InputText id="email" class="form-control" @bind-Value="email" />
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <InputText id="password" type="password" class="form-control" @bind-Value="password" />
    </div>

    <button type="submit" class="btn btn-primary">Add Teacher</button>
    <a href="/teachers" class="btn btn-secondary">Cancel</a>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private TeacherViewModel teacher { get; set; } = new();

    [SupplyParameterFromForm]
    private string? email { get; set; }

    [SupplyParameterFromForm]
    private string? password { get; set; }

    private async Task HandleValidSubmit()
    {
        string? userId = null;
        if (!string.IsNullOrWhiteSpace(email) && !string.IsNullOrWhiteSpace(password))
        {
            var result = await AuthService.RegisterAsync(new RegisterRequest {
                Email = email,
                Password = password,
                FirstName = teacher.FirstName,
                LastName = teacher.LastName
            });

            if (result.Success)
            {
                 // Find the user to get ID. RegisterAsync doesn't return ID currently.
                 var user = await UserManager.FindByEmailAsync(email);
                 if (user != null)
                 {
                     userId = user.Id;
                     // Ensure role is Teacher (Register defaults to Student)
                     if (!await UserManager.IsInRoleAsync(user, "Teacher"))
                     {
                         await UserManager.AddToRoleAsync(user, "Teacher");
                         await UserManager.RemoveFromRoleAsync(user, "Student");
                     }
                 }
            }
        }

        await TeacherService.AddTeacherAsync(teacher, userId);
        NavigationManager.NavigateTo("/teachers");
    }
}
